name: Safe Lane Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Enforce Safe Lane rules
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr.head.ref || "";
            const body = (pr.body || "");

            // Rule 1: rollback plan required for codex/* branches
            if (headRef.startsWith("codex/") && !body.includes("## Rollback plan")) {
              core.setFailed("Safe Lane: codex/* PRs must include a '## Rollback plan' section in the PR body.");
            }

            // Fetch changed files
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const names = files.map(f => f.filename);

            // Rule 2: codex/* touching sensitive paths requires explicit override text
            const sensitive = [
              /^\.github\/workflows\//,
              /^\.github\//,
              /^scripts\//,
              /^\.githooks\//,
              /^infra\//,
              /^terraform\//,
              /^docker\//,
              /^k8s\//,
              /(^|\/)\.env/i,
              /\.(pem|p12|key)$/i,
              /(keystore)/i,
              /^(package-lock\.json|pnpm-lock\.yaml|yarn\.lock)$/i,
              /^(requirements.*\.txt|poetry\.lock)$/i
            ];

            const touchedSensitive = names.some(n => sensitive.some(rx => rx.test(n)));

            if (headRef.startsWith("codex/") && touchedSensitive && !body.includes("SAFE_LANE_OVERRIDE: YES")) {
              core.setFailed("Safe Lane: codex/* PR touched sensitive paths. Add 'SAFE_LANE_OVERRIDE: YES' to the PR body and justify it.");
            }
